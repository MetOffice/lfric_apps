@@ -4,8 +4,8 @@
   use fs_continuity_mod, only : w2, w3, wtheta
   use kernel_mod, only : kernel_type
   implicit none
-  interface opt_apply_variable_hx_code
-  module procedure opt_apply_variable_hx_code_r_single, opt_apply_variable_hx_code_r_double
+  interface adj_opt_apply_variable_hx_code
+  module procedure adj_opt_apply_variable_hx_code_r_single, adj_opt_apply_variable_hx_code_r_double
 end interface
   type, public, extends(kernel_type) :: adj_opt_apply_variable_hx_kernel_type
   type(ARG_TYPE) :: META_ARGS(10) = (/ &
@@ -24,7 +24,7 @@
 
   private
 
-  public :: opt_apply_variable_hx_code
+  public :: adj_opt_apply_variable_hx_code
 
   contains
   subroutine adj_opt_apply_variable_hx_code_r_double(cell, nlayers, lhs, x, mt_inv, pressure, ncell_3d_1, div, ncell_3d_2, p3t, &
@@ -61,8 +61,6 @@
 
     div_u = 0.0_r_double
     t_e = 0.0_r_double
-    k = 0
-    ik = cell * nlayers + k - nlayers + 1
     k = nlayers - 1
     ik = cell * nlayers + k - nlayers + 1
     div_u = div_u + lhs(map_w3(1) + k) * sgn
@@ -70,22 +68,22 @@
     t_e(2) = t_e(2) + sgn * lhs(map_w3(1) + k)
     pressure(k + map_w3(1)) = pressure(k + map_w3(1)) + m3(1,1,ik) * lhs(map_w3(1) + k)
     rhs_p(k + map_w3(1)) = rhs_p(k + map_w3(1)) + lhs(map_w3(1) + k)
-    lhs(map_w3(1) + k) = 0.0
+    lhs(map_w3(1) + k) = 0.0_r_double
     x(k + map_w2(1)) = x(k + map_w2(1)) + div(1,1,ik) * div_u
     x(k + map_w2(2)) = x(k + map_w2(2)) + div(1,2,ik) * div_u
     x(k + map_w2(3)) = x(k + map_w2(3)) + div(1,3,ik) * div_u
     x(k + map_w2(4)) = x(k + map_w2(4)) + div(1,4,ik) * div_u
     x(k + map_w2(5)) = x(k + map_w2(5)) + div(1,5,ik) * div_u
     x(k + map_w2(6)) = x(k + map_w2(6)) + div(1,6,ik) * div_u
-    div_u = 0.0
+    div_u = 0.0_r_double
     x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,5,ik) * t_e(2)
     x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,6,ik) * t_e(2)
-    t_e(2) = 0.0
+    t_e(2) = 0.0_r_double
     x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,5,ik) * t_e(1)
     x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,6,ik) * t_e(1)
     x(k + map_w2(5) - 1) = x(k + map_w2(5) - 1) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(2,5,ik - 1) * t_e(1)
     x(k + map_w2(6) - 1) = x(k + map_w2(6) - 1) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(2,6,ik - 1) * t_e(1)
-    t_e(1) = 0.0
+    t_e(1) = 0.0_r_double
     do k = nlayers - 2, 1, -1
       ik = cell * nlayers + k - nlayers + 1
       div_u = div_u + lhs(map_w3(1) + k) * sgn
@@ -93,46 +91,48 @@
       t_e(2) = t_e(2) + sgn * lhs(map_w3(1) + k)
       pressure(k + map_w3(1)) = pressure(k + map_w3(1)) + m3(1,1,ik) * lhs(map_w3(1) + k)
       rhs_p(k + map_w3(1)) = rhs_p(k + map_w3(1)) + lhs(map_w3(1) + k)
-      lhs(map_w3(1) + k) = 0.0
+      lhs(map_w3(1) + k) = 0.0_r_double
       x(k + map_w2(1)) = x(k + map_w2(1)) + div(1,1,ik) * div_u
       x(k + map_w2(2)) = x(k + map_w2(2)) + div(1,2,ik) * div_u
       x(k + map_w2(3)) = x(k + map_w2(3)) + div(1,3,ik) * div_u
       x(k + map_w2(4)) = x(k + map_w2(4)) + div(1,4,ik) * div_u
       x(k + map_w2(5)) = x(k + map_w2(5)) + div(1,5,ik) * div_u
       x(k + map_w2(6)) = x(k + map_w2(6)) + div(1,6,ik) * div_u
-      div_u = 0.0
+      div_u = 0.0_r_double
       x(k + map_w2(5) + 1) = x(k + map_w2(5) + 1) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(1,5,ik + 1) * t_e(2)
       x(k + map_w2(6) + 1) = x(k + map_w2(6) + 1) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(1,6,ik + 1) * t_e(2)
       x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,5,ik) * t_e(2)
       x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,6,ik) * t_e(2)
-      t_e(2) = 0.0
+      t_e(2) = 0.0_r_double
       x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,5,ik) * t_e(1)
       x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,6,ik) * t_e(1)
       x(k + map_w2(5) - 1) = x(k + map_w2(5) - 1) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(2,5,ik - 1) * t_e(1)
       x(k + map_w2(6) - 1) = x(k + map_w2(6) - 1) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(2,6,ik - 1) * t_e(1)
-      t_e(1) = 0.0
+      t_e(1) = 0.0_r_double
     enddo
+    k = 0
+    ik = cell * nlayers + k - nlayers + 1
     div_u = div_u + lhs(map_w3(1) + k) * sgn
     t_e(1) = t_e(1) + sgn * lhs(map_w3(1) + k)
     t_e(2) = t_e(2) + sgn * lhs(map_w3(1) + k)
     pressure(k + map_w3(1)) = pressure(k + map_w3(1)) + m3(1,1,ik) * lhs(map_w3(1) + k)
     rhs_p(k + map_w3(1)) = rhs_p(k + map_w3(1)) + lhs(map_w3(1) + k)
-    lhs(map_w3(1) + k) = 0.0
+    lhs(map_w3(1) + k) = 0.0_r_double
     x(k + map_w2(1)) = x(k + map_w2(1)) + div(1,1,ik) * div_u
     x(k + map_w2(2)) = x(k + map_w2(2)) + div(1,2,ik) * div_u
     x(k + map_w2(3)) = x(k + map_w2(3)) + div(1,3,ik) * div_u
     x(k + map_w2(4)) = x(k + map_w2(4)) + div(1,4,ik) * div_u
     x(k + map_w2(5)) = x(k + map_w2(5)) + div(1,5,ik) * div_u
     x(k + map_w2(6)) = x(k + map_w2(6)) + div(1,6,ik) * div_u
-    div_u = 0.0
+    div_u = 0.0_r_double
     x(k + map_w2(5) + 1) = x(k + map_w2(5) + 1) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(1,5,ik + 1) * t_e(2)
     x(k + map_w2(6) + 1) = x(k + map_w2(6) + 1) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(1,6,ik + 1) * t_e(2)
     x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,5,ik) * t_e(2)
     x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,6,ik) * t_e(2)
-    t_e(2) = 0.0
+    t_e(2) = 0.0_r_double
     x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,5,ik) * t_e(1)
     x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,6,ik) * t_e(1)
-    t_e(1) = 0.0
+    t_e(1) = 0.0_r_double
 
   end subroutine adj_opt_apply_variable_hx_code_r_double
   subroutine adj_opt_apply_variable_hx_code_r_single(cell, nlayers, lhs, x, mt_inv, pressure, ncell_3d_1, div, ncell_3d_2, p3t, &
@@ -169,8 +169,6 @@
 
     div_u = 0.0_r_single
     t_e = 0.0_r_single
-    k = 0
-    ik = cell * nlayers + k - nlayers + 1
     k = nlayers - 1
     ik = cell * nlayers + k - nlayers + 1
     div_u = div_u + lhs(map_w3(1) + k) * sgn
@@ -178,22 +176,22 @@
     t_e(2) = t_e(2) + sgn * lhs(map_w3(1) + k)
     pressure(k + map_w3(1)) = pressure(k + map_w3(1)) + m3(1,1,ik) * lhs(map_w3(1) + k)
     rhs_p(k + map_w3(1)) = rhs_p(k + map_w3(1)) + lhs(map_w3(1) + k)
-    lhs(map_w3(1) + k) = 0.0
+    lhs(map_w3(1) + k) = 0.0_r_single
     x(k + map_w2(1)) = x(k + map_w2(1)) + div(1,1,ik) * div_u
     x(k + map_w2(2)) = x(k + map_w2(2)) + div(1,2,ik) * div_u
     x(k + map_w2(3)) = x(k + map_w2(3)) + div(1,3,ik) * div_u
     x(k + map_w2(4)) = x(k + map_w2(4)) + div(1,4,ik) * div_u
     x(k + map_w2(5)) = x(k + map_w2(5)) + div(1,5,ik) * div_u
     x(k + map_w2(6)) = x(k + map_w2(6)) + div(1,6,ik) * div_u
-    div_u = 0.0
+    div_u = 0.0_r_single
     x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,5,ik) * t_e(2)
     x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,6,ik) * t_e(2)
-    t_e(2) = 0.0
+    t_e(2) = 0.0_r_single
     x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,5,ik) * t_e(1)
     x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,6,ik) * t_e(1)
     x(k + map_w2(5) - 1) = x(k + map_w2(5) - 1) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(2,5,ik - 1) * t_e(1)
     x(k + map_w2(6) - 1) = x(k + map_w2(6) - 1) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(2,6,ik - 1) * t_e(1)
-    t_e(1) = 0.0
+    t_e(1) = 0.0_r_single
     do k = nlayers - 2, 1, -1
       ik = cell * nlayers + k - nlayers + 1
       div_u = div_u + lhs(map_w3(1) + k) * sgn
@@ -201,46 +199,48 @@
       t_e(2) = t_e(2) + sgn * lhs(map_w3(1) + k)
       pressure(k + map_w3(1)) = pressure(k + map_w3(1)) + m3(1,1,ik) * lhs(map_w3(1) + k)
       rhs_p(k + map_w3(1)) = rhs_p(k + map_w3(1)) + lhs(map_w3(1) + k)
-      lhs(map_w3(1) + k) = 0.0
+      lhs(map_w3(1) + k) = 0.0_r_single
       x(k + map_w2(1)) = x(k + map_w2(1)) + div(1,1,ik) * div_u
       x(k + map_w2(2)) = x(k + map_w2(2)) + div(1,2,ik) * div_u
       x(k + map_w2(3)) = x(k + map_w2(3)) + div(1,3,ik) * div_u
       x(k + map_w2(4)) = x(k + map_w2(4)) + div(1,4,ik) * div_u
       x(k + map_w2(5)) = x(k + map_w2(5)) + div(1,5,ik) * div_u
       x(k + map_w2(6)) = x(k + map_w2(6)) + div(1,6,ik) * div_u
-      div_u = 0.0
+      div_u = 0.0_r_single
       x(k + map_w2(5) + 1) = x(k + map_w2(5) + 1) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(1,5,ik + 1) * t_e(2)
       x(k + map_w2(6) + 1) = x(k + map_w2(6) + 1) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(1,6,ik + 1) * t_e(2)
       x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,5,ik) * t_e(2)
       x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,6,ik) * t_e(2)
-      t_e(2) = 0.0
+      t_e(2) = 0.0_r_single
       x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,5,ik) * t_e(1)
       x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,6,ik) * t_e(1)
       x(k + map_w2(5) - 1) = x(k + map_w2(5) - 1) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(2,5,ik - 1) * t_e(1)
       x(k + map_w2(6) - 1) = x(k + map_w2(6) - 1) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(2,6,ik - 1) * t_e(1)
-      t_e(1) = 0.0
+      t_e(1) = 0.0_r_single
     enddo
+    k = 0
+    ik = cell * nlayers + k - nlayers + 1
     div_u = div_u + lhs(map_w3(1) + k) * sgn
     t_e(1) = t_e(1) + sgn * lhs(map_w3(1) + k)
     t_e(2) = t_e(2) + sgn * lhs(map_w3(1) + k)
     pressure(k + map_w3(1)) = pressure(k + map_w3(1)) + m3(1,1,ik) * lhs(map_w3(1) + k)
     rhs_p(k + map_w3(1)) = rhs_p(k + map_w3(1)) + lhs(map_w3(1) + k)
-    lhs(map_w3(1) + k) = 0.0
+    lhs(map_w3(1) + k) = 0.0_r_single
     x(k + map_w2(1)) = x(k + map_w2(1)) + div(1,1,ik) * div_u
     x(k + map_w2(2)) = x(k + map_w2(2)) + div(1,2,ik) * div_u
     x(k + map_w2(3)) = x(k + map_w2(3)) + div(1,3,ik) * div_u
     x(k + map_w2(4)) = x(k + map_w2(4)) + div(1,4,ik) * div_u
     x(k + map_w2(5)) = x(k + map_w2(5)) + div(1,5,ik) * div_u
     x(k + map_w2(6)) = x(k + map_w2(6)) + div(1,6,ik) * div_u
-    div_u = 0.0
+    div_u = 0.0_r_single
     x(k + map_w2(5) + 1) = x(k + map_w2(5) + 1) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(1,5,ik + 1) * t_e(2)
     x(k + map_w2(6) + 1) = x(k + map_w2(6) + 1) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(1,6,ik + 1) * t_e(2)
     x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,5,ik) * t_e(2)
     x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(2)) * p3t(1,2,ik) * pt2(2,6,ik) * t_e(2)
-    t_e(2) = 0.0
+    t_e(2) = 0.0_r_single
     x(k + map_w2(5)) = x(k + map_w2(5)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,5,ik) * t_e(1)
     x(k + map_w2(6)) = x(k + map_w2(6)) + mt_inv(k + map_wt(1)) * p3t(1,1,ik) * pt2(1,6,ik) * t_e(1)
-    t_e(1) = 0.0
+    t_e(1) = 0.0_r_single
 
   end subroutine adj_opt_apply_variable_hx_code_r_single
 
