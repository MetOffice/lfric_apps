!-----------------------------------------------------------------------------
! (c) Crown copyright 2026 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

module assemble_w2h_from_w2hb_kernel_mod_test

  use contants_mod, only: i_def, r_solver
  use funit

  implicit none

  private

  public :: test_all

contains

  @test
  subroutine test_all()

    use assemble_w2h_from_w2hb_kernel_mod, only: assemble_w2h_from_w2hb_code

    implicit none

    integer(kind=i_def), parameter :: nlayers = 1
    integer(kind=i_def), parameter :: ndf_w2_broken = 4
    integer(kind=i_def), parameter :: ndf_w2 = 4
    integer(kind=i_def), parameter :: undf_w2_broken = 4*nlayers
    integer(kind=i_def), parameter :: undf_w2 = 4*nlayers
    integer(kind=i_def), dimension(ndf_w2_broken) :: map_w2_broken
    integer(kind=i_def), dimension(ndf_w2)        :: map_w2

    real(kind=r_solver), parameter :: tol = 1.0e-6_r_def

    real(kind=r_solver), dimension(undf_w2)        :: field_w2, answer
    real(kind=r_solver), dimension(undf_w2_broken) :: field_w2_broken

    map_w2_broken = (/1, 2, 3, 4/)
    map_w2 = map_w2_broken

    field_w2 = (/ 1.0_r_solver, 2.0_r_solver, 3.0_r_solver, 4.0_r_solver /)
    field_w2_broken = field_w2
    answer = field_w2 + field_w2_broken

    call assemble_w2h_from_w2hb_code( nlayers,          &
                                      field_w2,         &
                                      field_w2_broken,  &
                                      ndf_w2,           &
                                      undf_w2,          &
                                      map_w2,           &
                                      ndf_w2_broken,    &
                                      undf_w2_broken,   &
                                      map_w2_broken     &
                                    )

    @assertEqual( answer, field_w2, tol )

  end subroutine test_all

end module assemble_w2h_from_w2hb_kernel_mod_test

